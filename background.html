<script type="text/javascript" src="/js/lib/jquery-1.7.1.min.js"></script>
<script type="text/javascript" src="/js/lib/underscore.js"></script>
<script type="text/javascript" src="/js/lib/backbone.js"></script>
<script type="text/javascript">


// duck punching for fun and profit.
Backbone._sync = Backbone.sync;
Backbone.sync = function(method, model, options) {
    options = _.extend( options, {
        beforeSend: function(xhr) {
            xhr.setRequestHeader("Authorization", "Basic " + window.btoa( localStorage['assembla_username']  + ":" + localStorage['assembla_password'] ) );

	} });
    return Backbone._sync( method, model, options );
};

var AssemblaApp = {
    Models : {},
    Collections : {},
    Views : {},
    dispatcher : {},
    _data : {},
    _cache : {
	_spaces : {},
	getSpace : function (space_id){
	    if( this._spaces[space_id] ){
		return this._spaces[space_id];
	    }
	    return false;
	},
	addSpace : function (space){
	    if( this._spaces[space.get("id")] ){
		if( this._spaces[space.get("id")] != space ){
		    this._spaces[space.get("id")] = space;
		}
	    } else {
		this._spaces[space.get("id")] = space;
	    }
	}

    },
    getCache : function (){
	return this._cache;
    },
    _setData : function (key,value){
	this._data[key] = value;
    },

    getData : function (key){
	if( this._data[key] ){
	    return this._data[key];
	}
	return false;
    },

    hasData : function( key ){
	return ( this._data[key] ) ? true : false;
    },

    getActiveSpaces : function(){
	if( this.getData("activeSpaces") ){
	    return this.getData("activeSpaces");
	}
	return [];
    },
    getTimeLogs : function(){
	if( this.getData("timeLogs") ){
	    return this.getData("timeLogs");
	}
	return [];
    },

    _getUsername : function () {
	return localStorage['assembla_username'];
    },

    _getPassword : function () {
	return localStorage['assembla_password'];
    },

    _getService : function ( service_title ){
	if( this.AssemblaAPI.services[service_title] ){
	    return this.AssemblaAPI.services[service_title];
	} else {
	    return { 'uri' :  '',
		     'type' : '' };
	}
    },

    getAPIUrl : function(){
	return localStorage['assembla_api'];
    },

    _processUri : function (uri, args){

	var matches = uri.match(/\$\{([^\$}]+)\}/g);
	if( matches ){
	    for( var i = 0; i < matches.length; i++ ){
		var key = matches[i].slice(0, -1).slice(2);
		uri = uri.replace(matches[i], args[key] );
	    }
	}
	return uri;

    },


    _sortTicketsByDateAsc : function (ticket1, ticket2 ){

	if(ticket1.get("due_date") === undefined && ticket2.get("due_date") == undefined){
	    return 1;
	} else if(ticket1.get("due_date") === undefined){
	    return 1;
	} else if(ticket2.get("due_date") === undefined){
	    return -1;
	} else {

	    var date1 = new Date(ticket1.get("due_date"));
	    var date2 = new Date(ticket2.get("due_date"));
	    if( date1 == date2 ){
		return 0;
	    } else if( date1 > date2 ) {
		return 1;
	    } else {
		return -1;
	    }
	}
    },

    getActiveTickets : function(){
	if( this.getActiveSpaces().length ){
	    // tickets is a collection so we need to map
	    // toArray onto it before flattening all the arrays
	    // and sorting. functional programing for the win!
	    return new this.Collections.Ticket(
		_.flatten(
		    _.map( AssemblaApp.getActiveSpaces().pluck("tickets"),
			   function( value ) { return value.toArray() }) )
		    .sort( this._sortTicketsByDateAsc ));

	}
	return new this.Collections.Ticket([]);
    },


    bootstrapActiveSpaces : function() {

	this._setData('activeSpaces', new AssemblaApp.Collections.Space( [], {
	    model : AssemblaApp.Models.Space
	}) );

	this.getActiveSpaces().url = this.getAPIUrl() + "/activetickets";
	this.getActiveSpaces().fetch( );
    },

    bootstrapTimeLogs : function() {

	this._setData('timeLogs', new AssemblaApp.Collections.TimeLog( [], {
	    model : AssemblaApp.Models.TimeLog
	}) );

	this.getTimeLogs().url = this.getAPIUrl() + "/user/time_entries";
	this.getTimeLogs().fetch();

    },


    getBaseUrl : function( uri ){
	if( !uri ) { uri = ''; }

	if( this.AssemblaAPI.defaults.url ){
	    return "www.assembla.com/" + uri;
	}

	return  '';
    },

    getSpaceBaseUrl : function( uri ){
	if( !uri ) { uri = ''; }
	return this.getBaseUrl( "/spaces/" + uri );
    },


    withSpace : function( space_id, callback ){
	if( this.getActiveSpaces().get(space_id) ){
	    callback = _.bind( callback, this.getActiveSpaces().get(space_id) );
	    callback();
	} else if( this.getCache().getSpace(space_id) ){
	    callback = _.bind( callback, this.getCache().getSpace(space_id));
	    callback();
	} else {
	    var space = new this.Models.Space();

	    space.url = this.getSpaceBaseUrl( space_id );
	    this.getCache().addSpace( space );

	    _.bind( callback, this.getCache().getSpace(space_id) );
	    space.fetch({
		success : callback
	    });
	}

    },

    run : function() {
	this.dispatcher = _.clone(Backbone.Events);
    }

};



AssemblaApp.Models.Ticket = Backbone.Model.extend({ });
AssemblaApp.Collections.Ticket = Backbone.Collection.extend({ model: AssemblaApp.Models.Ticket });


AssemblaApp.Models.Space = Backbone.Model.extend({
    initialize : function() {
	if( this.get("tickets") ){
	    this.set("tickets", new AssemblaApp.Collections.Ticket( this.get("tickets"), {
		model : AssemblaApp.Models.Ticket
	    }) );
	}
	this._ticketCache = new AssemblaApp.Collections.Ticket();
    },

    getTickets : function() {
	if( this.get("tickets") ){
	    return this.get("tickets");
	}
	return new AssemblaApp.Collections.Ticket();
    },

    withTicket : function (ticket_number, callback ){
	if( this.getTickets().where({ number : ticket_number}).length ){
	    callback = _.bind( callback, this.getTickets().where({ number : ticket_number })[0] );
	    callback();
	} else if( this._ticketCache.where({ number : ticket_number}).length ){
	    callback = _.bind( callback, this._ticketCache.where({ number : ticket_number})[0] );
	    callback();
	} else {
	    var ticket =  new AssemblaApp.Models.Ticket();
	    ticket.url = AssemblaApp.getAPIUrl() + '/spaces/' + this.get("id") + '/tickets/' + ticket_number;

	    this._ticketCache.add( ticket );
	    callback = _.bind(callback, ticket);

	    ticket.fetch({
		success : callback
	    });

	}
    }
});

AssemblaApp.Collections.Space = Backbone.Collection.extend({ model: AssemblaApp.Models.Space });


AssemblaApp.Models.TimeLog = Backbone.Model.extend({});
AssemblaApp.Collections.TimeLog = Backbone.Collection.extend({ model: AssemblaApp.Models.TimeLog });







AssemblaApp.run();
</script>
