<script type="text/javascript" src="/js/lib/jquery-1.7.1.min.js"></script>
<script type="text/javascript" src="/js/lib/underscore-min.js"></script>
<script type="text/javascript">

var AssemblaApp = {
    _data : {},

    _setData : function (key,value){
	this._data[key] = value;
    },

    getData : function (key){
	if( this._data[key] ){
	    return this._data[key];
	}
	return false;
    },

    getActiveSpaces : function(){
	if( this.getData("activeSpaces") ){
	    return this.getData("activeSpaces");
	}
	return [];
    },

    getActiveTickets : function(){
	if( this.getData("activeTickets") ){
	    return this.getData("activeTickets");
	}
	return [];
    },

    _getUsername : function () {
	return localStorage['assembla_username'];
    },

    _getPassword : function () {
	return localStorage['assembla_password'];
    },

    _getService : function ( service_title ){
	if( this.AssemblaAPI.services[service_title] ){
	    return this.AssemblaAPI.services[service_title];
	} else {
	    return { 'uri' :  '',
		     'type' : '' };
	}
    },

    _getAPIUrl : function(){
	return localStorage['assembla_api'];
    },

    _processUri : function (uri, args){

	var matches = uri.match(/\$\{([^\$}]+)\}/g);
	if( matches ){
	    for( var i = 0; i < matches.length; i++ ){
		var key = matches[i].slice(0, -1).slice(2);
		uri = uri.replace(matches[i], args[key] );
	    }
	}
	return uri;

    },

    _ajaxCall : function( uri, callback ){

	callback = _.bind(callback, this);

	jQuery.ajax({
	    cache: true,
	    async: true,
	    username: this._getUsername(),
	    password: this._getPassword(),
	    dataType: 'json',
	    url: this._getAPIUrl() + "/" + uri,
	    success: callback

	});

    },


    _callService : function( service_title, args, callback ){
	this._ajaxCall(this._processUri( this._getService(service_title).uri, args ), callback);
    },


        
    loadAssemblaAPI : function(){
	this._ajaxCall( 'getconfig', function(data){
	    this.AssemblaAPI = data;
	    this.bootstrapActiveSpaces();
	});
    },


    bootstrapActiveSpaces : function() {

	this._ajaxCall('activetickets',function(resp) {
	    console.log(resp);
	    this._setData('activeSpaces', resp);
	    this._setData('activeTickets', _.flatten(_.map(AssemblaApp.getActiveSpaces(), function(space) { return space.active_tickets; })));
	});
    },


    getActiveTicketsForSpace : function( space_id ){
	var space = this.getSpace(space_id);
	if( space ){
	    return space.active_tickets;
	} else {
	    return [];
	}
    },

    getSpaceBaseUrl : function( uri ){
	if( !uri ) { uri = ''; }
	if( this.AssemblaAPI.defaults.url ){
	    return this.AssemblaAPI.defaults.url + "/spaces/" + uri;
	}
	return '';
    },
    getSpaceName : function( space_id ){
	return _.filter( this.getActiveSpaces(), function(item) { return item.id == space_id })[0].name;
    },

    getWikiName : function( space_id ){
	return _.filter( this.getActiveSpaces(), function(item) { return item.id == space_id })[0].wiki_name;
    },

    getTicketNumber : function( ticket_id ){
	return _.filter( this.getActiveTickets(), function(item) { return item.id == ticket_id })[0].number;
    },

    getSpace : function( space_id, callback ){
	return _.filter( this.getActiveSpaces(), function(item) { return item.id == space_id })[0];
    },

    run : function() {
	this.loadAssemblaAPI();
    }
};

AssemblaApp.run();
</script>
